define the quality<define-lang.org:bank:/account> {
    define the position<balance> {
        it may only contain dimension points where {
            it has the quality<define-lang.org:bank:/nonzero>.
        }
    }

    define the trigger {
        it triggers when  {
            this quality is assigned.
        } and it does {
            create a dimension point in position<balance>.
            assign the quality<define-lang.org:bank:/nonzero> to position<balance>.
        }
    }

    define the trigger<deposit> {
        define the position<run>.
        define the position<amount> {
            it may only contain dimension points where {
                it has the quality<define-lang.org:bank:/nonzero>.
            }
        }

        it triggers when {
            the position<run> has a dimension point.
            AND
            the position<amount> has a dimension point.
        } and it does {
            set the value in position<balance> to position<balance> plus position<amount>.
            destroy the dimension point in position<run>.
        }
    }

    define the trigger<withdraw> {
        define the position<run> {
            it may only be destroyed by trigger<withdraw>.
        }
        define the position<amount> {
            it may only contain dimension points where {
                it has the quality<define-lang.org:bank:/nonzero>.
            }
        }

        it triggers when {
            the position<run> has a dimension point.
            AND
            the position<from> has a dimension point.
            AND
            the position<amount> has a dimension point.
        }  and it requires {
            the value in position<balance> is greater than the value in position<amount>.
            OR
            the value in position<balance> is equal to the value in position<amount>.
        } and it does {
            set the value in position<balance> to position<balance> minus position<amount>.
            destroy the dimension point in position<run>.
        }
    }

    define the trigger<transfer_to> {
        define the position<run> {
            it may only be destroyed by trigger<transfer_to>.
        }
        define the position<to> {
            it may only contain dimension points where {
                it has the quality<define-lang.org:bank:/account>.
            }
        }
        define the position<amount> {
            it may only contain dimension points where {
                it has the quality<define-lang.org:bank:/nonzero>.
            }
        }

        it triggers when {
            the position<run> has a dimension point.
            AND
            the position<to> has a dimension point.
            AND
            the position<amount> has a dimension point.
        } and it requires {
            the value in position<balance> is greater than the value in position<amount>.
            OR
            the value in position<balance> is equal to the value in position<amount>.
        } and it does {
            # This feels like something the compiler should be able to optimize away.
            if {
                trigger<withdraw>::position<amount> is empty.
            } then {
                create a dimension point in trigger<withdraw>::position<amount>.
                assign the quality<define-lang.org:bank:/nonzero> to trigger<withdraw>::position<amount>.
            }
            set the value in trigger<withdraw>::position<amount> to position<amount>.
            create a dimension point in trigger<withdraw>::position<run>.

            it triggers when {
                the position in trigger<withdraw>::position<run> is empty.
            } and it does {
                # This feels like something the compiler should be able to optimize away.
                if {
                    position<to>::trigger<deposit>::position<amount> is empty.
                } then {
                    # It's too easy to human-error this and write the wrong trigger names.
                    create a dimension point in trigger<to>::position<amount>.
                    assign the quality<define-lang.org:bank:/nonzero> to trigger<to>::position<amount>.
                }
                set the value in trigger<deposit>::position<amount> to position<amount>.
                create a dimension point in trigger<deposit>::position<run>.

                it triggers when {
                    the position trigger<deposit>::position<run> is empty.
                } and it does {
                    destroy the dimension point in position<run>.
                }
            }
        }
    }
}
// Lark grammar for the Define language subset supported by the current compiler

// Define UNIVERSE_NAME with explicit priority before IDENTIFIER import
// Higher priority ensures it matches before IDENTIFIER
UNIVERSE_NAME.2: "AbstractUniverse" | "PhysicalUniverse"

%import common.CNAME            -> IDENTIFIER
%import common.ESCAPED_STRING   -> STRING
%import common.SIGNED_NUMBER    -> NUMBER

SPACE: " "

// Newline carries following indentation so that the parser can see it for indentation purposes.
// We allow multiple consecutive newlines so blank lines don't reset indentation.
_NEWLINE: /(\n[ ]*)+/

POSSESSIVE: "'s"

%declare INDENT DEDENT

COMMENT: /[ ]*#[^\n]*/
%ignore COMMENT

// A file is one or more universe blocks.
start: _ignored_line* universe_section (_ignored_line* universe_section)* _ignored_line*

_ignored_line: _blank_line

// A universe block with statements indented by exactly one level.
universe_section: UNIVERSE_NAME ":" _NEWLINE INDENT (_blank_line | compiler_type_declaration | type_declaration | property_declaration | knowledge_statement | action_execution | entity_creation | action_declaration)+ DEDENT

_blank_line: _NEWLINE

// Compiler type declaration (e.g., Number is.).
compiler_type_declaration: IDENTIFIER SPACE "is." _NEWLINE

// Type declaration with parent type (e.g., Source is a ViewPoint.).
type_declaration: IDENTIFIER SPACE "is a" SPACE IDENTIFIER "." _NEWLINE

// Property declaration for types.
property_declaration: IDENTIFIER SPACE "has a" SPACE IDENTIFIER SPACE "named" SPACE IDENTIFIER "." _NEWLINE

// Entity creation with a nested property block.
entity_creation: IDENTIFIER SPACE "creates a" SPACE IDENTIFIER SPACE "named" SPACE IDENTIFIER ":" _NEWLINE INDENT property_assignment+ DEDENT

property_assignment: IDENTIFIER ":" SPACE value_reference _NEWLINE

?value_reference: STRING
                | NUMBER
                | property_or_entity_reference

property_or_entity_reference: IDENTIFIER POSSESSIVE SPACE IDENTIFIER

knowledge_statement: IDENTIFIER SPACE "knows" SPACE property_or_entity_reference "." _NEWLINE

action_declaration: IDENTIFIER SPACE "can" SPACE IDENTIFIER action_parameters? ":" _NEWLINE INDENT action_body DEDENT

action_parameters: SPACE "using" SPACE action_param (parameter_sep action_param)*
parameter_sep: "," (SPACE* _NEWLINE)? SPACE*
action_param: "a" SPACE IDENTIFIER SPACE "named" SPACE IDENTIFIER

action_body: (_blank_line | action_execution)+

action_execution: IDENTIFIER SPACE "makes" SPACE value_reference SPACE IDENTIFIER SPACE argument_list "." _NEWLINE
argument_list: value_reference ("," (SPACE* _NEWLINE)? SPACE* value_reference)*
